---
title: Webhooks
sidebar_label: Webhooks
sidebar_position: 11
---

## Overview

Platform sends async notifications (webhooks) to merchant's configured URL when key events occur. All webhook notifications follow a unified structure.

---

## Notification Structure

```json
{
  "notifyId": "NOTIFY202601070001",
  "notifyType": "AGREEMENT_SIGN",
  "notifyTime": "2026-01-07 10:30:05",
  "merchantId": "M123456789",
  "data": {
    // Business data (varies by notifyType)
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

### Common Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| notifyId | string | Notification unique ID (for deduplication) |
| notifyType | string | Notification type |
| notifyTime | string | Notification time (yyyy-MM-dd HH:mm:ss) |
| merchantId | string | Merchant ID |
| data | object | Business data |
| sign | string | Signature (Base64 encoded) |
| signType | string | Signature algorithm: `RSA2` |

### Notification Types

| notifyType | Description |
|:-----------|:------------|
| `AGREEMENT_SIGN` | Sign result notification |
| `AGREEMENT_PAY` | Deduction result notification |
| `AGREEMENT_REFUND` | Refund result notification |
| `AGREEMENT_UNSIGN` | Agreement unsign notification |
| `AGREEMENT_SUSPEND` | Agreement suspend notification |
| `AGREEMENT_RESUME` | Agreement resume notification |
| `AGREEMENT_TIMEOUT` | Sign timeout notification |
| `ORDER_TIMEOUT` | Order timeout notification |

---

## Sign Result Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| agreementNo | string | Platform agreement number |
| externalAgreementNo | string | Merchant agreement number |
| agreementType | string | Sign type: `CYCLE` / `SINGLE` |
| status | string | Sign status: `SIGNED` / `FAILED` |
| userId | string | Platform user ID |
| merchantUserId | string | Merchant-side user ID |
| sceneCode | string | Scene code |
| signTime | string | Sign time (on success) |
| failureReason | string | Failure reason (on failure) |

### Example (Success)

```json
{
  "notifyId": "NOTIFY202601070001",
  "notifyType": "AGREEMENT_SIGN",
  "notifyTime": "2026-01-07 10:30:05",
  "merchantId": "M123456789",
  "data": {
    "agreementNo": "AGR202601070001",
    "externalAgreementNo": "MERCHANT_AGR_001",
    "agreementType": "CYCLE",
    "status": "SIGNED",
    "userId": "U_123456789",
    "merchantUserId": "merchant_user_123",
    "sceneCode": "SUBSCRIPTION",
    "signTime": "2026-01-07 10:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

### Example (Failure)

```json
{
  "notifyId": "NOTIFY202601070002",
  "notifyType": "AGREEMENT_SIGN",
  "notifyTime": "2026-01-07 10:35:05",
  "merchantId": "M123456789",
  "data": {
    "agreementNo": "AGR202601070002",
    "externalAgreementNo": "MERCHANT_AGR_002",
    "agreementType": "CYCLE",
    "status": "FAILED",
    "userId": "U_123456789",
    "merchantUserId": "merchant_user_123",
    "sceneCode": "SUBSCRIPTION",
    "failureReason": "USER_AUTH_TIMEOUT"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Deduction Result Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| orderNo | string | Platform order number |
| tradeNo | string | Platform trade number |
| outTradeNo | string | Merchant order number |
| agreementNo | string | Platform agreement number |
| status | string | Transaction status: `SUCCESS` / `FAILED` |
| amount | object | Amount object |
| amount.total | string | Amount (minimum unit) |
| amount.currency | string | Currency code |
| amount.currency_type | string | Currency type |
| payTime | string | Payment time (on success) |
| failureReason | string | Failure reason (on failure) |

### Example (Success)

```json
{
  "notifyId": "NOTIFY202601070003",
  "notifyType": "AGREEMENT_PAY",
  "notifyTime": "2026-01-07 10:30:05",
  "merchantId": "M123456789",
  "data": {
    "orderNo": "ORD202601070001",
    "tradeNo": "PAY202601070001",
    "outTradeNo": "ORDER20260107001",
    "agreementNo": "AGR202601070001",
    "status": "SUCCESS",
    "amount": {
      "total": "2350",
      "currency": "USDT",
      "currency_type": "CRYPTO"
    },
    "payTime": "2026-01-07 10:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

### Example (Failure)

```json
{
  "notifyId": "NOTIFY202601070004",
  "notifyType": "AGREEMENT_PAY",
  "notifyTime": "2026-01-07 10:30:05",
  "merchantId": "M123456789",
  "data": {
    "orderNo": "ORD202601070002",
    "tradeNo": "PAY202601070002",
    "outTradeNo": "ORDER20260107002",
    "agreementNo": "AGR202601070001",
    "status": "FAILED",
    "amount": {
      "total": "5000",
      "currency": "USDT",
      "currency_type": "CRYPTO"
    },
    "failureReason": "BALANCE_NOT_ENOUGH"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Refund Result Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| orderNo | string | Platform order number |
| refundNo | string | Platform refund number |
| outRefundNo | string | Merchant refund number |
| tradeNo | string | Original trade number |
| outTradeNo | string | Original merchant order number |
| agreementNo | string | Platform agreement number |
| status | string | Refund status: `SUCCESS` / `FAILED` |
| refund_amount | object | Refund amount object |
| refundTime | string | Refund time (on success) |
| failureReason | string | Failure reason (on failure) |

### Example

```json
{
  "notifyId": "NOTIFY202601070005",
  "notifyType": "AGREEMENT_REFUND",
  "notifyTime": "2026-01-07 11:30:05",
  "merchantId": "M123456789",
  "data": {
    "orderNo": "ORD202601070003",
    "refundNo": "RF202601070001",
    "outRefundNo": "REFUND20260107001",
    "tradeNo": "PAY202601070001",
    "outTradeNo": "ORDER20260107001",
    "agreementNo": "AGR202601070001",
    "status": "SUCCESS",
    "refund_amount": {
      "total": "2350",
      "currency": "USDT",
      "currency_type": "CRYPTO"
    },
    "refundTime": "2026-01-07 11:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Agreement Unsign Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| agreementNo | string | Platform agreement number |
| externalAgreementNo | string | Merchant agreement number |
| status | string | Agreement status: `UNSIGNED` |
| unsignType | string | Unsign type: `USER` / `MERCHANT` / `EXPIRED` / `SYSTEM` |
| unsignTime | string | Unsign time |

### Example

```json
{
  "notifyId": "NOTIFY202601070006",
  "notifyType": "AGREEMENT_UNSIGN",
  "notifyTime": "2026-01-07 15:30:05",
  "merchantId": "M123456789",
  "data": {
    "agreementNo": "AGR202601070001",
    "externalAgreementNo": "MERCHANT_AGR_001",
    "status": "UNSIGNED",
    "unsignType": "USER",
    "unsignTime": "2026-01-07 15:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Agreement Suspend Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| agreementNo | string | Platform agreement number |
| externalAgreementNo | string | Merchant agreement number |
| status | string | Agreement status: `SUSPENDED` |
| suspendReason | string | Suspend reason: `RISK` / `ABNORMAL` / `MANUAL` |
| suspendTime | string | Suspend time |

### Example

```json
{
  "notifyId": "NOTIFY202601070007",
  "notifyType": "AGREEMENT_SUSPEND",
  "notifyTime": "2026-01-07 16:30:05",
  "merchantId": "M123456789",
  "data": {
    "agreementNo": "AGR202601070001",
    "externalAgreementNo": "MERCHANT_AGR_001",
    "status": "SUSPENDED",
    "suspendReason": "RISK",
    "suspendTime": "2026-01-07 16:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Agreement Resume Notification

### data Fields

| Parameter | Type | Description |
|:----------|:-----|:------------|
| agreementNo | string | Platform agreement number |
| externalAgreementNo | string | Merchant agreement number |
| status | string | Agreement status: `SIGNED` |
| resumeTime | string | Resume time |

### Example

```json
{
  "notifyId": "NOTIFY202601070008",
  "notifyType": "AGREEMENT_RESUME",
  "notifyTime": "2026-01-07 18:30:05",
  "merchantId": "M123456789",
  "data": {
    "agreementNo": "AGR202601070001",
    "externalAgreementNo": "MERCHANT_AGR_001",
    "status": "SIGNED",
    "resumeTime": "2026-01-07 18:30:00"
  },
  "sign": "Base64 encoded signature",
  "signType": "RSA2"
}
```

---

## Webhook Handling

### Request Headers

| Parameter | Type | Description |
|:----------|:-----|:------------|
| X-Timestamp | string | Notification timestamp (milliseconds) |
| X-Signature | string | Notification signature |
| X-Nonce | string | Random string |
| Content-Type | string | `application/json` |

### Retry Mechanism

| Configuration | Value |
|:--------------|:------|
| Retry count | Maximum 5 retries |
| Retry interval | 15s, 30s, 1min, 5min, 30min |
| Success indicator | HTTP 200 with body `success` |
| Timeout | 10 seconds per request |

### Merchant Response

Return plain text `success` (case insensitive) with HTTP 200:

```
success
```

### Handling Code Example (Java)

```java
@RestController
@RequestMapping("/webhook")
public class WebhookController {

    @PostMapping("/agreement")
    public ResponseEntity<String> handleWebhook(
            @RequestHeader("X-Timestamp") String timestamp,
            @RequestBody String body) {

        JSONObject notify = JSON.parseObject(body);
        String sign = notify.getString("sign");

        // 1. Remove sign and signType for verification
        notify.remove("sign");
        notify.remove("signType");
        String contentToVerify = notify.toJSONString();

        // 2. Verify signature
        if (!verifySignature(contentToVerify, sign)) {
            return ResponseEntity.status(400).body("signature_error");
        }

        // 3. Check timestamp (prevent replay)
        if (Math.abs(System.currentTimeMillis() - Long.parseLong(timestamp)) > 5 * 60 * 1000) {
            return ResponseEntity.status(400).body("timestamp_expired");
        }

        // 4. Idempotency check
        String notifyId = notify.getString("notifyId");
        if (isProcessed(notifyId)) {
            return ResponseEntity.ok("success");
        }

        // 5. Process business
        String notifyType = notify.getString("notifyType");
        JSONObject data = notify.getJSONObject("data");

        switch (notifyType) {
            case "AGREEMENT_SIGN":
                handleSignNotify(data);
                break;
            case "AGREEMENT_PAY":
                handlePayNotify(data);
                break;
            case "AGREEMENT_REFUND":
                handleRefundNotify(data);
                break;
            // ... other types
        }

        markAsProcessed(notifyId);
        return ResponseEntity.ok("success");
    }
}
```

---

## Notes

1. **Deduplication**: Use `notifyId` to prevent duplicate processing
2. **Signature Verification**: Always verify signature before processing
3. **Idempotency**: Same notification may be sent multiple times; ensure idempotent handling
4. **Response Quickly**: Return `success` immediately; process business asynchronously if needed
